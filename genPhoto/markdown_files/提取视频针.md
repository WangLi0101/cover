# æå–è§†é¢‘å¸§ - å‰ç«¯è§†é¢‘å¤„ç†æŠ€æœ¯

![å°é¢å›¾](../photo/video-frame-cover.webp)

## ğŸ“– ç®€ä»‹

åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦ä»è§†é¢‘ä¸­æå–ç‰¹å®šå¸§ä½œä¸ºå›¾ç‰‡ä½¿ç”¨ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ **HTML5 Canvas** æŠ€æœ¯å®ç°è§†é¢‘å¸§çš„æå–ï¼Œè¿™æ˜¯ä¸€ç§çº¯å‰ç«¯çš„è§£å†³æ–¹æ¡ˆï¼Œæ— éœ€æœåŠ¡ç«¯æ”¯æŒã€‚

---

## ğŸ¯ åº”ç”¨åœºæ™¯

è§†é¢‘å¸§æå–æŠ€æœ¯åœ¨å®é™…å¼€å‘ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼š

| åœºæ™¯ | æè¿° |
|------|------|
| **è§†é¢‘å°é¢ç”Ÿæˆ** | è‡ªåŠ¨ä»è§†é¢‘ä¸­æå–æŸä¸€å¸§ä½œä¸ºå°é¢ç¼©ç•¥å›¾ |
| **è§†é¢‘é¢„è§ˆ** | ç”Ÿæˆè§†é¢‘æ—¶é—´è½´ä¸Šçš„é¢„è§ˆç¼©ç•¥å›¾æ¡ |
| **è§†é¢‘ç¼–è¾‘å™¨** | å®ç°å¸§çº§åˆ«çš„è§†é¢‘ç¼–è¾‘åŠŸèƒ½ |
| **å†…å®¹å®¡æ ¸** | æå–å…³é”®å¸§ç”¨äºå†…å®¹åˆè§„æ£€æŸ¥ |
| **è§†é¢‘è½¬ GIF** | æå–å¤šå¸§åˆæˆ GIF åŠ¨ç”» |

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯åŸç†

### æŠ€æœ¯æ ˆ

- **HTML5 Video**: ç”¨äºåŠ è½½å’Œæ’­æ”¾è§†é¢‘æ–‡ä»¶
- **Canvas 2D API**: ç”¨äºæ•è·è§†é¢‘ç”»é¢å¹¶è½¬æ¢ä¸ºå›¾ç‰‡
- **Blob API**: ç”¨äºå¤„ç†äºŒè¿›åˆ¶æ•°æ®å’Œç”Ÿæˆå¯ç”¨çš„å›¾ç‰‡ URL

### å®ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸Šä¼ è§†é¢‘æ–‡ä»¶   â”‚ -> â”‚ åˆ›å»º Video å…ƒç´   â”‚ -> â”‚  è®¾ç½®æ’­æ”¾æ—¶é—´    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿”å›å›¾ç‰‡ URL  â”‚ <- â”‚ Canvas è½¬ Blob  â”‚ <- â”‚ Canvas ç»˜åˆ¶å¸§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **`URL.createObjectURL()`**: å°† File å¯¹è±¡è½¬æ¢ä¸ºå¯è¢« video å…ƒç´ åŠ è½½çš„ä¸´æ—¶ URL
2. **`video.currentTime`**: è®¾ç½®è§†é¢‘æ’­æ”¾ä½ç½®ï¼Œç²¾ç¡®å®šä½åˆ°ç›®æ ‡å¸§
3. **`ctx.drawImage()`**: å°†å½“å‰è§†é¢‘å¸§ç»˜åˆ¶åˆ° Canvas ä¸Š
4. **`canvas.toBlob()`**: å°† Canvas å†…å®¹å¼‚æ­¥è½¬æ¢ä¸º Blob å¯¹è±¡

---

## ğŸ’» å®Œæ•´å®ç°ä»£ç 

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è§†é¢‘å¸§æå–å™¨</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: white;
        margin-bottom: 20px;
      }
      .frames-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
      }
      .frames-container img {
        width: 100%;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¬ è§†é¢‘å¸§æå–å™¨</h1>
      <div class="upload-area">
        <input type="file" accept="video/*" id="videoInput" />
        <p>é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶æ¥æå–å¸§</p>
      </div>
      <div class="frames-container" id="framesContainer"></div>
    </div>

    <script>
      /**
       * ä»è§†é¢‘æ–‡ä»¶ä¸­æå–æŒ‡å®šæ—¶é—´ç‚¹çš„å¸§
       * @param {File} file - è§†é¢‘æ–‡ä»¶å¯¹è±¡
       * @param {number} time - è¦æå–çš„æ—¶é—´ç‚¹ï¼ˆç§’ï¼‰
       * @param {string} format - è¾“å‡ºå›¾ç‰‡æ ¼å¼ï¼Œé»˜è®¤ 'image/jpeg'
       * @param {number} quality - å›¾ç‰‡è´¨é‡ 0-1ï¼Œé»˜è®¤ 0.8
       * @returns {Promise<{url: string, width: number, height: number}>}
       */
      const captureFrame = (file, time, format = 'image/jpeg', quality = 0.8) => {
        return new Promise((resolve, reject) => {
          // 1. åˆ›å»ºè§†é¢‘æ–‡ä»¶çš„ä¸´æ—¶ URL
          const url = URL.createObjectURL(file);
          
          // 2. åˆ›å»º video å…ƒç´ 
          const video = document.createElement("video");
          
          // 3. é…ç½®è§†é¢‘å±æ€§
          // æ³¨æ„ï¼šæµè§ˆå™¨å®‰å…¨ç­–ç•¥è¦æ±‚é™éŸ³æ‰èƒ½è‡ªåŠ¨æ’­æ”¾
          video.muted = true;
          video.autoplay = true;
          // å…è®¸è·¨åŸŸï¼ˆå¦‚æœè§†é¢‘æ¥è‡ªå¤–éƒ¨æºï¼‰
          video.crossOrigin = "anonymous";
          // é¢„åŠ è½½å…ƒæ•°æ®
          video.preload = "metadata";
          
          // 4. è®¾ç½®è§†é¢‘æº
          video.src = url;
          
          // 5. é”™è¯¯å¤„ç†
          video.onerror = () => {
            URL.revokeObjectURL(url);
            reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
          };
          
          // 6. å½“è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåè®¾ç½®æ—¶é—´
          video.onloadedmetadata = () => {
            // ç¡®ä¿è¯·æ±‚çš„æ—¶é—´ä¸è¶…è¿‡è§†é¢‘æ€»æ—¶é•¿
            video.currentTime = Math.min(time, video.duration);
          };
          
          // 7. å½“è§†é¢‘å¯ä»¥æ’­æ”¾æ—¶ï¼ˆå¸§å·²å‡†å¤‡å¥½ï¼‰
          video.oncanplay = () => {
            try {
              // åˆ›å»º Canvas å…ƒç´ 
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              
              // è®¾ç½® Canvas å°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              
              // å°†å½“å‰è§†é¢‘å¸§ç»˜åˆ¶åˆ° Canvas
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              
              // å°† Canvas è½¬æ¢ä¸º Blob
              canvas.toBlob(
                (blob) => {
                  if (blob) {
                    // é‡Šæ”¾ä¹‹å‰çš„è§†é¢‘ URL
                    URL.revokeObjectURL(url);
                    
                    // è¿”å›ç»“æœ
                    resolve({
                      url: URL.createObjectURL(blob),
                      width: canvas.width,
                      height: canvas.height,
                      time: time,
                      size: blob.size
                    });
                  } else {
                    reject(new Error('Canvas è½¬æ¢å¤±è´¥'));
                  }
                },
                format,
                quality
              );
            } catch (error) {
              reject(error);
            }
          };
        });
      };

      /**
       * æ‰¹é‡æå–è§†é¢‘å¸§
       * @param {File} file - è§†é¢‘æ–‡ä»¶
       * @param {number} count - è¦æå–çš„å¸§æ•°
       * @param {number} interval - å¸§é—´éš”ï¼ˆç§’ï¼‰
       */
      const captureMultipleFrames = async (file, count = 10, interval = 1) => {
        const frames = [];
        for (let i = 0; i < count; i++) {
          try {
            const frame = await captureFrame(file, i * interval);
            frames.push(frame);
          } catch (error) {
            console.warn(`å¸§ ${i} æå–å¤±è´¥:`, error);
          }
        }
        return frames;
      };

      // é¡µé¢äº¤äº’é€»è¾‘
      const inputElement = document.getElementById("videoInput");
      const framesContainer = document.getElementById("framesContainer");

      inputElement.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // æ¸…ç©ºä¹‹å‰çš„å¸§
        framesContainer.innerHTML = '<p>æ­£åœ¨æå–å¸§...</p>';
        
        try {
          // æå–å‰ 20 å¸§ï¼Œæ¯ç§’ä¸€å¸§
          const frames = await captureMultipleFrames(file, 20, 1);
          
          // æ¸…ç©ºåŠ è½½æç¤º
          framesContainer.innerHTML = '';
          
          // æ˜¾ç¤ºæå–çš„å¸§
          frames.forEach((frame, index) => {
            const img = document.createElement("img");
            img.src = frame.url;
            img.title = `ç¬¬ ${frame.time} ç§’ - ${frame.width}x${frame.height}`;
            framesContainer.appendChild(img);
          });
        } catch (error) {
          framesContainer.innerHTML = `<p style="color: red;">æå–å¤±è´¥: ${error.message}</p>`;
        }
      });
    </script>
  </body>
</html>
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æµè§ˆå™¨å…¼å®¹æ€§

| æµè§ˆå™¨ | æ”¯æŒæƒ…å†µ |
|--------|---------|
| Chrome | âœ… å®Œå…¨æ”¯æŒ |
| Firefox | âœ… å®Œå…¨æ”¯æŒ |
| Safari | âš ï¸ éƒ¨åˆ†è§†é¢‘æ ¼å¼å¯èƒ½ä¸æ”¯æŒ |
| Edge | âœ… å®Œå…¨æ”¯æŒ |
| IE | âŒ ä¸æ”¯æŒ |

### 2. è§†é¢‘æ ¼å¼æ”¯æŒ

æµè§ˆå™¨å¯¹è§†é¢‘æ ¼å¼çš„æ”¯æŒå–å†³äºå…¶å†…ç½®çš„è§†é¢‘è§£ç å™¨ï¼š

- **MP4 (H.264)**: æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ
- **WebM (VP8/VP9)**: Chromeã€Firefox æ”¯æŒè¾ƒå¥½
- **MOV**: ä¸»è¦åœ¨ Safari ä¸­æ”¯æŒè‰¯å¥½

### 3. æ€§èƒ½è€ƒè™‘

- å¤§æ–‡ä»¶å¤„ç†æ—¶å¯èƒ½ä¼šå ç”¨è¾ƒå¤šå†…å­˜
- å»ºè®®ä½¿ç”¨ Web Worker è¿›è¡Œå¼‚æ­¥å¤„ç†
- åŠæ—¶è°ƒç”¨ `URL.revokeObjectURL()` é‡Šæ”¾å†…å­˜

### 4. å®‰å…¨é™åˆ¶

- è·¨åŸŸè§†é¢‘éœ€è¦æœåŠ¡å™¨é…ç½® CORS å¤´
- æœ¬åœ°æ–‡ä»¶éœ€è¦é€šè¿‡ `<input type="file">` ä¸Šä¼ 

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ Web Worker

å°†å¸§æå–é€»è¾‘æ”¾åˆ° Web Worker ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼š

```javascript
// åœ¨ Web Worker ä¸­ä½¿ç”¨ OffscreenCanvas
const offscreen = new OffscreenCanvas(width, height);
const ctx = offscreen.getContext('2d');
```

### 2. èŠ‚æµä¸é˜²æŠ–

å½“éœ€è¦å®æ—¶é¢„è§ˆæ—¶ï¼Œä½¿ç”¨èŠ‚æµæ§åˆ¶æå–é¢‘ç‡ï¼š

```javascript
const throttle = (fn, delay) => {
  let lastCall = 0;
  return (...args) => {
    const now = Date.now();
    if (now - lastCall >= delay) {
      lastCall = now;
      return fn(...args);
    }
  };
};
```

### 3. å›¾ç‰‡å‹ç¼©

ä½¿ç”¨ `toBlob` çš„ quality å‚æ•°æ§åˆ¶è¾“å‡ºå¤§å°ï¼š

```javascript
canvas.toBlob(callback, 'image/jpeg', 0.6); // 60% è´¨é‡
```

---

## ğŸ“š ç›¸å…³ API å‚è€ƒ

- [HTMLVideoElement](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLVideoElement)
- [Canvas API](https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API)
- [URL.createObjectURL()](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL)
- [Blob](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob)

---

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ HTML5 Canvas æŠ€æœ¯ä»è§†é¢‘ä¸­æå–å¸§ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ï¼š

1. **çº¯å‰ç«¯å®ç°**ï¼šæ— éœ€æœåŠ¡ç«¯æ”¯æŒ
2. **çµæ´»æ€§é«˜**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶æå–æ—¶é—´ç‚¹
3. **å…¼å®¹æ€§å¥½**ï¼šé€‚ç”¨äºæ‰€æœ‰ç°ä»£æµè§ˆå™¨

å¸Œæœ›æœ¬æ–‡å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿äº¤æµè®¨è®ºã€‚
